---
layout: post
title:  "《LoRaWAN规范》第3章"
date:   2018-03-14 10:45:13 +0800
background: '/img/posts/06.jpg'
---

### 3 物理层消息格式
LoRa术语上分为上行消息和下行消息。
#### 3.1 上行链路消息
**上行链路消息** 是由终端经一个或多个网关发往服务器的消息。

上行链路消息通过LoRa无线分组显示模式传输，包含LoRa物理帧头（PHDR）和头部CRC字段（PHDR_CRC）。CRC负责保证payload的完整性。

其中，PHDR、PHDR_CRC和payload的CRC字段均由射频收发机完成插入。

| Preamble | PHDR | PHDR_CRC | PHYPayload | CRC |
| -------- | ---- | -------- | ---------- | --- |
<center>图2 上行物理帧格式</center>

#### 3.2 下行链路消息
每条**下行链路消息**均是由服务器发给单一终端，且是经单一网关转发。

下行链路消息同样通过LoRa无线分组显示模式传输，包含LoRa物理帧头（PHDR）和头部CRC字段（PHDR_CRC）。
| Preamble | PHDR | PHDR_CRC | PHYPayload |
| -------- | ---- | -------- | ---------- |
<center>图3 下行物理帧格式</center>

#### 3.3 接收窗口
终端在每次发送上行数据之后会短暂开启两个接收窗口。接收窗口的开启时间以上行数据发送完成为基准，附加一个设定时延。

![end-device receive receive slot timing](https://raw.githubusercontent.com/qigeloveit/LoRaWAN_Specification_Learning/master/image/end-device_receive_slot_timing.png)
<center>图4 终端接收时序图</center>

##### 3.3.1 第一个接收窗口信道、数据传输速率和开启
第一个接收窗口RX1使用的频率与上行链路相同，数据传输速率为上行链路数据传输速率的函数。RX1在上行数据传输完成`RECEIVE_DELAY1`秒（+/-20 毫秒）之后开启。上行链路和RX1下行链路所使用的数据传输速率跟地域相关，详见《LoRaWAN Regional Parameters》第7章。默认情况下第一个接收窗口数据传输速率与上一次上行链路相同。

##### 3.3.2 第二个接收窗口信道、数据传输速率和开启
第二个接收窗口RX2使用经修正可配置的频率和数据传输速率，并在上行数据传输完成`RECEIVE_DELAY2`秒（+/-20 毫秒）之后开启。其频率和数据传输速率可通过MAC命令修改（见第5章节）。默认频率和数据传输速率跟地域相关，详见《LoRaWAN Regional Parameters》第7章。

##### 3.3.3 接收窗口时长
接收窗口的长度必须至少足够终端的无线收发机有效检测到下行数据前导码。

##### 3.3.4 接收窗口期的接收行为
如果无线接收机在某个接收窗口检测到前导码，则将会保持接收状态，直到下行帧解调完成。如果某帧数据在第一个接收窗口被检测到并解调完成，且通过地址和MIC（消息完整码）检查确认该帧数据是发往本终端时，则不再开启第二个接收窗口。

##### 3.3.5 服务器往终端发送消息
服务器总是会精准地在两个接收窗口的开始时刻往终端发送下行消息。

##### 3.3.6 接收窗口的重要事项
终端在发送上行数据后，不应该在收到下行消息或第二个接收窗口关闭之前，再次发送上行消息。

##### 3.3.7 其他协议数据的收发
终端在符合当地规定并兼容LoRaWAN规范的前提下，可通过LoRaWAN收发窗口传输其他协议数据或进行任何传输。